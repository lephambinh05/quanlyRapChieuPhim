# H·ªÜ TH·ªêNG QU·∫¢N L√ù R·∫†P CHI·∫æU PHIM
## Gi·∫£i th√≠ch Code v√† Design Patterns (13-15 ph√∫t)

---

## üìã T·ªîNG QUAN H·ªÜ TH·ªêNG

**C√¥ng ngh·ªá s·ª≠ d·ª•ng:**
- **Backend:** ASP.NET Core MVC (.NET 8.0)
- **Database:** SQL Server v·ªõi Entity Framework Core
- **Frontend:** Razor Views, Bootstrap 5, JavaScript
- **Real-time:** SignalR cho chat v√† th√¥ng b√°o
- **Authentication:** JWT, Two-Factor Authentication, Google OAuth
- **Email:** SMTP v·ªõi Gmail
- **Background Services:** Cron jobs cho banking check

**Ki·∫øn tr√∫c:** MVC Pattern v·ªõi Repository Pattern v√† Service Layer

---

## üéØ 4 CH·ª®C NƒÇNG CH√çNH (3-4 ph√∫t/ch·ª©c nƒÉng)

---

### 1. üé´ ƒê·∫∂T V√â TR·ª∞C TUY·∫æN (Online Ticket Booking)

#### **M·ª•c ƒë√≠ch:** Cho ph√©p kh√°ch h√†ng ƒë·∫∑t v√© phim tr·ª±c tuy·∫øn v·ªõi giao di·ªán th√¢n thi·ªán

#### **Code th·ª±c t·∫ø v√† Design Patterns:**

**1. MVC Pattern v·ªõi Repository Pattern:**
```csharp
// Controllers/KhachHangController.cs - D√≤ng 46-214
public async Task<IActionResult> Index(string? theLoai, string? searchTerm, string? sortBy, string? sortOrder)
{
    try
    {
        _logger.LogInformation("[ACTION] [Index] Email: {Email}, theLoai: {TheLoai}, searchTerm: {SearchTerm}, sortBy: {SortBy}, sortOrder: {SortOrder}, SessionKeys: {SessionKeys}", 
            HttpContext.Session.GetString("Email"), theLoai, searchTerm, sortBy, sortOrder, string.Join(",", HttpContext.Session.Keys));
        
        if (!IsCustomerLoggedIn())
        {
            return RedirectToAction("Login", "Auth");
        }

        // Repository Pattern: S·ª≠ d·ª•ng Entity Framework ƒë·ªÉ truy v·∫•n d·ªØ li·ªáu
        var lichChieuQuery = _context.LichChieus
            .Include(lc => lc.Phim)
            .Include(lc => lc.PhongChieu)
            .Where(lc => lc.ThoiGianBatDau > DateTime.Now);

        // Strategy Pattern: X·ª≠ l√Ω filter v√† sort kh√°c nhau
        if (!string.IsNullOrEmpty(theLoai))
            lichChieuQuery = lichChieuQuery.Where(lc => lc.Phim.TheLoai == theLoai);
            
        if (!string.IsNullOrEmpty(searchTerm))
            lichChieuQuery = lichChieuQuery.Where(lc => lc.Phim.TenPhim.Contains(searchTerm));

        // Command Pattern: X·ª≠ l√Ω sort
        lichChieuQuery = sortBy switch
        {
            "tenPhim" => sortOrder == "desc" ? lichChieuQuery.OrderByDescending(lc => lc.Phim.TenPhim) : lichChieuQuery.OrderBy(lc => lc.Phim.TenPhim),
            "thoiGian" => sortOrder == "desc" ? lichChieuQuery.OrderByDescending(lc => lc.ThoiGianBatDau) : lichChieuQuery.OrderBy(lc => lc.ThoiGianBatDau),
            "gia" => sortOrder == "desc" ? lichChieuQuery.OrderByDescending(lc => lc.Gia) : lichChieuQuery.OrderBy(lc => lc.Gia),
            _ => lichChieuQuery.OrderBy(lc => lc.ThoiGianBatDau)
        };

        var lichChieus = await lichChieuQuery.ToListAsync();
        return View(lichChieus);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "L·ªói trong Index action");
        return View(new List<LichChieu>());
    }
}
```

**2. Observer Pattern (Real-time seat selection):**
```csharp
// Controllers/KhachHangController.cs - D√≤ng 214-283
public async Task<IActionResult> ChonGhe(string maLichChieu)
{
    HttpContext.Session.Remove("maHoaDon");
    WriteErrorLog($"[ACTION] [{DateTime.Now:yyyy-MM-dd HH:mm:ss}] [ChonGhe] Email: {HttpContext.Session.GetString("Email")}, maLichChieu: {maLichChieu}, SessionKeys: {string.Join(",", HttpContext.Session.Keys)}");
    
    if (!IsCustomerLoggedIn())
    {
        return RedirectToAction("Login", "Auth");
    }

    // Repository Pattern: Load data v·ªõi Include
    var lichChieu = await _context.LichChieus
        .Include(lc => lc.Phim)
        .Include(lc => lc.PhongChieu)
            .ThenInclude(pc => pc.GheNgois)
        .FirstOrDefaultAsync(lc => lc.MaLichChieu == maLichChieu);

    // Observer Pattern: Theo d√µi tr·∫°ng th√°i gh·∫ø
    var danhSachGhe = await _context.GheNgois
        .Where(g => g.MaPhong == lichChieu.MaPhong)
        .OrderBy(g => g.SoGhe)
        .ToListAsync();

    var danhSachVeDaBan = await _context.Ves
        .Where(v => v.MaLichChieu == maLichChieu && v.TrangThai == "ƒê√£ b√°n")
        .ToListAsync();

    // Factory Pattern: T·∫°o ViewModel
    var viewModel = new KhachHangChonGheViewModel
    {
        LichChieu = lichChieu,
        DanhSachGhe = danhSachGhe,
        DanhSachVeDaBan = danhSachVeDaBan,
        DanhSachVeDaPhatHanh = danhSachVeDaPhatHanh,
        GheDaDat = gheDaDat
    };

    return View(viewModel);
}
```

**3. Builder Pattern (T·∫°o h√≥a ƒë∆°n):**
```csharp
// Controllers/KhachHangController.cs - D√≤ng 283-998
public async Task<IActionResult> ThanhToan(string? maHoaDon)
{
    // Builder Pattern: X√¢y d·ª±ng h√≥a ƒë∆°n t·ª´ng b∆∞·ªõc
    var hoaDon = new HoaDon
    {
        MaHoaDon = GenerateMaHoaDon(),
        ThoiGianTao = DateTime.Now,
        TrangThai = "Ch·ªù chuy·ªÉn kho·∫£n",
        TongTien = tongTien,
        maKhachHang = maKhachHang,
        maNhanVien = null // Kh√°ch h√†ng t·ª± ƒë·∫∑t
    };

    _context.HoaDons.Add(hoaDon);
    await _context.SaveChangesAsync();

    // Observer Pattern: Th√¥ng b√°o real-time
    await _chatHub.SendPaymentStatus(hoaDon.MaHoaDon, "Ch·ªù thanh to√°n");

    return RedirectToAction("HuongDanChuyenKhoan", new { maHoaDon = hoaDon.MaHoaDon });
}
```

#### **Lu·ªìng x·ª≠ l√Ω th·ª±c t·∫ø:**
1. **Hi·ªÉn th·ªã l·ªãch chi·∫øu** ‚Üí MVC Pattern + Repository Pattern
2. **Ch·ªçn phim v√† su·∫•t chi·∫øu** ‚Üí Strategy Pattern (filter/sort)
3. **Ch·ªçn gh·∫ø** ‚Üí Observer Pattern (real-time updates)
4. **T·∫°o h√≥a ƒë∆°n** ‚Üí Builder Pattern
5. **Thanh to√°n** ‚Üí Command Pattern

---

### 2. üí≥ THANH TO√ÅN CHUY·ªÇN KHO·∫¢N (Bank Transfer Payment)

#### **M·ª•c ƒë√≠ch:** X·ª≠ l√Ω thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng v·ªõi x√°c th·ª±c t·ª± ƒë·ªông

#### **Code th·ª±c t·∫ø v√† Design Patterns:**

**1. Service Pattern v·ªõi Background Processing:**
```csharp
// Services/BankingService.cs - D√≤ng 1-238
public class BankingService
{
    private readonly CinemaDbContext _context;
    private readonly string _logFilePath;
    private readonly string _apiUrl;

    public BankingService(CinemaDbContext context)
    {
        _context = context;
        _logFilePath = Path.Combine("logs", "banking_log.txt");
        _apiUrl = "https://api.sieuthicode.net/historyapiacbv2/978225ae27ff5741c543da2ae7d44123";
    }

    // Service Pattern: X·ª≠ l√Ω logic banking
    public async Task<BankingCheckResult> CheckBankingTransactionsAsync()
    {
        var result = new BankingCheckResult
        {
            Timestamp = DateTime.Now,
            TotalTransactions = 0,
            MatchedOrders = 0,
            UpdatedOrders = 0,
            Errors = new List<string>()
        };

        try
        {
            await LogToFile($"=== B·∫ÆT ƒê·∫¶U KI·ªÇM TRA BANKING {DateTime.Now:yyyy-MM-dd HH:mm:ss} ===");

            // Repository Pattern: L·∫•y ƒë∆°n h√†ng ch·ªù thanh to√°n
            var pendingOrders = await _context.HoaDons
                .Where(h => h.TrangThai == "Ch·ªù chuy·ªÉn kho·∫£n")
                .ToListAsync();

            // Strategy Pattern: X·ª≠ l√Ω t·ª´ng lo·∫°i giao d·ªãch
            var transactions = await GetBankingTransactionsAsync();
            
            foreach (var transaction in transactions)
            {
                // Command Pattern: X·ª≠ l√Ω t·ª´ng giao d·ªãch
                var matchedOrder = await ProcessTransactionAsync(transaction, pendingOrders);
                if (matchedOrder != null)
                {
                    result.MatchedOrders++;
                    result.UpdatedOrders++;
                }
            }

            return result;
        }
        catch (Exception ex)
        {
            result.Errors.Add(ex.Message);
            return result;
        }
    }
}
```

**2. Observer Pattern (Real-time payment status):**
```csharp
// Hubs/ChatHub.cs - D√≤ng 1-24
public class ChatHub : Hub
{
    private readonly CinemaDbContext _context;
    private readonly ILogger<ChatHub> _logger;
    private readonly IChatLogService _chatLogService;
    private static readonly Dictionary<string, string> _userConnections = new();

    // Observer Pattern: Th√¥ng b√°o tr·∫°ng th√°i thanh to√°n
    public async Task SendPaymentStatus(string maHoaDon, string status)
    {
        await Clients.All.SendAsync("ReceivePaymentStatus", maHoaDon, status);
        _chatLogService.LogMessage("payment", "system", "System", $"Payment status updated: {maHoaDon} - {status}");
    }
}
```

**3. Cron Job Pattern (Background processing):**
```csharp
// Controllers/CronController.cs - D√≤ng 1-37
[ApiController]
[Route("api/cron")]
[AllowAnonymous]
public class CronController : ControllerBase
{
    private readonly CinemaDbContext _context;
    private readonly BankingService _bankingService;

    public CronController(CinemaDbContext context, BankingService bankingService)
    {
        _context = context;
        _bankingService = bankingService;
    }

    // Cron Job Pattern: Ch·∫°y ƒë·ªãnh k·ª≥
    [HttpGet("")]
    public async Task<IActionResult> RunAllCrons()
    {
        var log = new List<object>();
        int totalPaid = 0, totalCancelled = 0, totalReleasedSeats = 0;

        // 1. Ki·ªÉm tra thanh to√°n ng√¢n h√†ng
        var bankingResult = await _bankingService.CheckBankingTransactionsAsync();
        totalPaid = bankingResult.UpdatedOrders;
        log.Add(new { step = "banking", result = bankingResult });

        return Ok(new { 
            success = true, 
            totalPaid, 
            totalCancelled, 
            totalReleasedSeats,
            log 
        });
    }
}
```

#### **Lu·ªìng x·ª≠ l√Ω th·ª±c t·∫ø:**
1. **T·∫°o h√≥a ƒë∆°n** ‚Üí Builder Pattern
2. **Hi·ªÉn th·ªã th√¥ng tin chuy·ªÉn kho·∫£n** ‚Üí Template Method Pattern
3. **Ki·ªÉm tra thanh to√°n** ‚Üí Service Pattern + Cron Job
4. **C·∫≠p nh·∫≠t tr·∫°ng th√°i** ‚Üí Observer Pattern
5. **G·ª≠i th√¥ng b√°o** ‚Üí Command Pattern

---

### 3. üéüÔ∏è PH√ÅT H√ÄNH V√â (Ticket Issuance)

#### **M·ª•c ƒë√≠ch:** Cho ph√©p nh√¢n vi√™n ph√°t h√†nh v√© h√†ng lo·∫°t v√† qu·∫£n l√Ω v√©

#### **Code th·ª±c t·∫ø v√† Design Patterns:**

**1. Repository Pattern v·ªõi LINQ:**
```csharp
// Controllers/PhatHanhVeController.cs - D√≤ng 1-403
public class PhatHanhVeController : Controller
{
    private readonly CinemaDbContext _context;

    public PhatHanhVeController(CinemaDbContext context)
    {
        _context = context;
    }

    // Repository Pattern: Truy v·∫•n d·ªØ li·ªáu v·ªõi Include
    public async Task<IActionResult> Index(DateTime? tuNgay, DateTime? denNgay, string? maPhim, string? maPhong)
    {
        if (!IsManagerOrStaff())
        {
            return RedirectToAction("Login", "Auth");
        }

        var lichChieusQuery = _context.LichChieus
            .Include(l => l.Phim)
            .Include(l => l.PhongChieu)
            .Include(l => l.NhanVien)
            .AsQueryable();

        // Strategy Pattern: X·ª≠ l√Ω filter kh√°c nhau
        if (tuNgay.HasValue)
        {
            lichChieusQuery = lichChieusQuery.Where(l => l.ThoiGianBatDau.Date >= tuNgay.Value.Date);
        }

        if (denNgay.HasValue)
        {
            lichChieusQuery = lichChieusQuery.Where(l => l.ThoiGianBatDau.Date <= denNgay.Value.Date);
        }

        if (!string.IsNullOrEmpty(maPhim))
        {
            lichChieusQuery = lichChieusQuery.Where(l => l.MaPhim == maPhim);
        }

        if (!string.IsNullOrEmpty(maPhong))
        {
            lichChieusQuery = lichChieusQuery.Where(l => l.MaPhong == maPhong);
        }

        var lichChieus = await lichChieusQuery
            .OrderBy(l => l.ThoiGianBatDau)
            .ToListAsync();

        return View(lichChieus);
    }
}
```

**2. Factory Pattern (T·∫°o v√© h√†ng lo·∫°t):**
```csharp
// Controllers/PhatHanhVeController.cs - D√≤ng 178-285
[HttpPost]
public async Task<IActionResult> PhatHanhHangLoat(string maLichChieu, List<string> selectedSeats)
{
    if (!IsManagerOrStaff())
    {
        return Json(new { success = false, message = "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" });
    }

    try
    {
        // Factory Pattern: T·∫°o v√© cho t·ª´ng gh·∫ø ƒë∆∞·ª£c ch·ªçn
        var ves = new List<Ve>();
        foreach (var maGhe in selectedSeats)
        {
            var ve = new Ve
            {
                MaVe = GenerateMaVe(),
                MaLichChieu = maLichChieu,
                MaGhe = maGhe,
                TrangThai = "Ch∆∞a ƒë·∫∑t",
                Gia = lichChieu.Gia,
                HanSuDung = lichChieu.ThoiGianBatDau.AddDays(30)
            };
            ves.Add(ve);
        }

        // Repository Pattern: L∆∞u v√†o database
        _context.Ves.AddRange(ves);
        await _context.SaveChangesAsync();

        return Json(new { success = true, soLuongVe = ves.Count });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = ex.Message });
    }
}
```

**3. Command Pattern (C·∫≠p nh·∫≠t tr·∫°ng th√°i v√©):**
```csharp
// Controllers/PhatHanhVeController.cs - D√≤ng 285-339
[HttpPost]
public async Task<IActionResult> CapNhatTrangThai(string maVe, string trangThai)
{
    if (!IsManagerOrStaff())
    {
        return Json(new { success = false, message = "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" });
    }

    // Command Pattern: X·ª≠ l√Ω command c·∫≠p nh·∫≠t tr·∫°ng th√°i
    var ve = await _context.Ves.FirstOrDefaultAsync(v => v.MaVe == maVe);
    if (ve == null)
    {
        return Json(new { success = false, message = "Kh√¥ng t√¨m th·∫•y v√©" });
    }

    ve.TrangThai = trangThai;
    await _context.SaveChangesAsync();

    return Json(new { success = true, message = "C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng" });
}
```

#### **Lu·ªìng x·ª≠ l√Ω th·ª±c t·∫ø:**
1. **Validate input** ‚Üí Template Method Pattern
2. **Generate tickets** ‚Üí Factory Pattern
3. **Save to database** ‚Üí Repository Pattern
4. **Update status** ‚Üí Command Pattern
5. **Send notifications** ‚Üí Observer Pattern

---

### 4. üìä DASHBOARD B√ÅO C√ÅO (Reporting Dashboard)

#### **M·ª•c ƒë√≠ch:** Hi·ªÉn th·ªã th·ªëng k√™ v√† b√°o c√°o chi ti·∫øt v·ªÅ ho·∫°t ƒë·ªông r·∫°p phim

#### **Code th·ª±c t·∫ø v√† Design Patterns:**

**1. Repository Pattern v·ªõi LINQ Aggregation:**
```csharp
// Controllers/QuanLyController.cs - D√≤ng 1-755
public class QuanLyController : Controller
{
    private readonly CinemaDbContext _context;

    public QuanLyController(CinemaDbContext context)
    {
        _context = context;
    }

    // Repository Pattern: Truy v·∫•n th·ªëng k√™
    public async Task<IActionResult> Index(DateTime? tuNgay, DateTime? denNgay, string? tenPhim)
    {
        if (!IsManagerOrStaff())
        {
            return RedirectToAction("Login", "Auth");
        }

        var today = DateTime.Today;
        var thisWeek = today.AddDays(-(int)today.DayOfWeek);
        var thisMonth = new DateTime(today.Year, today.Month, 1);

        // Repository Pattern v·ªõi LINQ queries
        var veQuery = _context.Ves
            .Include(v => v.LichChieu)
                .ThenInclude(lc => lc.Phim)
            .AsQueryable();

        // Strategy Pattern: X·ª≠ l√Ω filter kh√°c nhau
        if (tuNgay.HasValue)
            veQuery = veQuery.Where(v => v.HanSuDung.HasValue && v.HanSuDung.Value.Date >= tuNgay.Value.Date);
        if (denNgay.HasValue)
            veQuery = veQuery.Where(v => v.HanSuDung.HasValue && v.HanSuDung.Value.Date <= denNgay.Value.Date);
        if (!string.IsNullOrEmpty(tenPhim))
            veQuery = veQuery.Where(v => v.LichChieu.Phim.TenPhim.Contains(tenPhim));

        // Aggregation Pattern: T√≠nh to√°n th·ªëng k√™
        var dashboardData = new DashboardViewModel
        {
            VeHomNay = await veQuery.CountAsync(v => v.HanSuDung.HasValue && v.HanSuDung.Value.Date == today),
            DoanhThuHomNay = await veQuery.Where(v => v.HanSuDung.HasValue && v.HanSuDung.Value.Date == today).SumAsync(v => v.Gia),
            TongKhachHang = await _context.KhachHangs.CountAsync(),
            TopPhim = await _context.LichChieus
                .Include(lc => lc.Phim)
                .GroupBy(lc => lc.Phim.TenPhim)
                .Select(g => new PhimViewModel
                {
                    TenPhim = g.Key,
                    SoVe = g.Count()
                })
                .OrderByDescending(p => p.SoVe)
                .Take(5)
                .ToListAsync()
        };

        return View(dashboardData);
    }
}
```

**2. Strategy Pattern (C√°c lo·∫°i b√°o c√°o kh√°c nhau):**
```csharp
// Controllers/QuanLyController.cs - D√≤ng 308-707
private async Task<List<DoanhThuTheoThangViewModel>> GetDoanhThuTheoThangAsync(int nam)
{
    var result = new List<DoanhThuTheoThangViewModel>();

    // Strategy Pattern: X·ª≠ l√Ω t·ª´ng th√°ng kh√°c nhau
    for (int thang = 1; thang <= 12; thang++)
    {
        var startDate = new DateTime(nam, thang, 1);
        var endDate = startDate.AddMonths(1).AddDays(-1);

        var doanhThu = await _context.Ves
            .Where(v => v.HanSuDung.HasValue && 
                       v.HanSuDung.Value >= startDate && 
                       v.HanSuDung.Value <= endDate)
            .SumAsync(v => v.Gia);

        var soVe = await _context.Ves
            .Where(v => v.HanSuDung.HasValue && 
                       v.HanSuDung.Value >= startDate && 
                       v.HanSuDung.Value <= endDate)
            .CountAsync();

        result.Add(new DoanhThuTheoThangViewModel
        {
            Thang = thang,
            Nam = nam,
            DoanhThu = doanhThu,
            SoVe = soVe
        });
    }

    return result;
}
```

**3. Observer Pattern (Real-time updates):**
```csharp
// Controllers/QuanLyController.cs - D√≤ng 707-755
[HttpGet]
public async Task<IActionResult> GetRealTimeStats()
{
    if (!IsManager())
    {
        return Json(new { success = false, message = "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" });
    }

    // Observer Pattern: C·∫≠p nh·∫≠t real-time
    var stats = new
    {
        VeHomNay = await _context.Ves
            .Where(v => v.HanSuDung.HasValue && v.HanSuDung.Value.Date == DateTime.Today)
            .CountAsync(),
        DoanhThuHomNay = await _context.Ves
            .Where(v => v.HanSuDung.HasValue && v.HanSuDung.Value.Date == DateTime.Today)
            .SumAsync(v => v.Gia),
        TongKhachHang = await _context.KhachHangs.CountAsync(),
        TongNhanVien = await _context.NhanViens.CountAsync()
    };

    return Json(new { success = true, data = stats });
}
```

#### **Lu·ªìng x·ª≠ l√Ω th·ª±c t·∫ø:**
1. **Thu th·∫≠p d·ªØ li·ªáu** ‚Üí Repository Pattern
2. **X·ª≠ l√Ω th·ªëng k√™** ‚Üí Strategy Pattern
3. **Aggregate data** ‚Üí Aggregation Pattern
4. **Hi·ªÉn th·ªã real-time** ‚Üí Observer Pattern
5. **Export b√°o c√°o** ‚Üí Template Method Pattern

---

## üèóÔ∏è KI·∫æN TR√öC T·ªîNG TH·ªÇ

### **Layered Architecture th·ª±c t·∫ø:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Presentation Layer        ‚îÇ
‚îÇ        (Controllers + Views)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           Business Layer            ‚îÇ
‚îÇ         (Services + Logic)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           Data Access Layer         ‚îÇ
‚îÇ      (DbContext + Repository)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           Database Layer            ‚îÇ
‚îÇ           (SQL Server)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Dependency Injection th·ª±c t·∫ø:**
```csharp
// Program.cs - D√≤ng 1-90
builder.Services.AddScoped<CinemaDbContext>();
builder.Services.AddScoped<BankingService>();
builder.Services.AddScoped<IEmailService, EmailService>();
builder.Services.AddScoped<IPasswordResetService, PasswordResetService>();
builder.Services.AddScoped<ITwoFactorService, TwoFactorService>();
builder.Services.AddScoped<IChatLogService, ChatLogService>();
builder.Services.AddMemoryCache();
builder.Services.AddSignalR();
```

---

## üîß C√ÅC L·ªÜNH V√Ä H√ÄM QUAN TR·ªåNG

### **Entity Framework Commands th·ª±c t·∫ø:**
```bash
# T·∫°o migration
dotnet ef migrations add AddNewFeature

# C·∫≠p nh·∫≠t database
dotnet ef database update

# X√≥a migration cu·ªëi
dotnet ef migrations remove
```

### **LINQ Queries th·ª±c t·∫ø:**
```csharp
// Include related data
var lichChieu = await _context.LichChieus
    .Include(lc => lc.Phim)
    .Include(lc => lc.PhongChieu)
    .FirstOrDefaultAsync(lc => lc.MaLichChieu == maLichChieu);

// Group by v√† aggregate
var revenueByDate = await _context.Ves
    .Where(v => v.HanSuDung.HasValue)
    .GroupBy(v => v.HanSuDung.Value.Date)
    .Select(g => new { Date = g.Key, Revenue = g.Sum(v => v.Gia) })
    .ToListAsync();

// Count v√† Any
var hasTickets = await _context.Ves
    .AnyAsync(v => v.MaLichChieu == maLichChieu);
```

### **JavaScript Functions th·ª±c t·∫ø:**
```javascript
// Real-time updates
function updateSeatStatus(seatId, isSelected) {
    const seat = document.getElementById(seatId);
    seat.classList.toggle('selected', isSelected);
    
    // Observer pattern: Th√¥ng b√°o cho c√°c component kh√°c
    hubConnection.invoke("UpdateSeatStatus", seatId, isSelected);
}

// Form validation
function validatePaymentForm() {
    const amount = document.getElementById('amount').value;
    const accountNumber = document.getElementById('accountNumber').value;
    
    if (!amount || !accountNumber) {
        showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return false;
    }
    
    return true;
}
```

---

## üìà HI·ªÜU SU·∫§T V√Ä T·ªêI ∆ØU H√ìA

### **Caching Strategy th·ª±c t·∫ø:**
- **Memory Cache:** Dashboard data, user sessions
- **Database Query Optimization:** Include, Where clauses
- **Real-time Updates:** SignalR for live data

### **Security Measures th·ª±c t·∫ø:**
- **JWT Authentication:** Secure API endpoints
- **Two-Factor Authentication:** Enhanced security
- **Input Validation:** Prevent SQL injection
- **HTTPS:** Encrypted communication

### **Error Handling th·ª±c t·∫ø:**
```csharp
try
{
    // Business logic
}
catch (SqlException ex)
{
    _logger.LogError(ex, "Database error");
    return Json(new { success = false, message = "L·ªói c∆° s·ªü d·ªØ li·ªáu" });
}
catch (Exception ex)
{
    _logger.LogError(ex, "Unexpected error");
    return Json(new { success = false, message = "L·ªói h·ªá th·ªëng" });
}
```

---

## üéØ K·∫æT LU·∫¨N

H·ªá th·ªëng qu·∫£n l√Ω r·∫°p chi·∫øu phim ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi ki·∫øn tr√∫c MVC hi·ªán ƒë·∫°i, √°p d·ª•ng nhi·ªÅu design patterns ƒë·ªÉ ƒë·∫£m b·∫£o:

1. **T√≠nh m·ªü r·ªông:** D·ªÖ d√†ng th√™m t√≠nh nƒÉng m·ªõi
2. **T√≠nh b·∫£o tr√¨:** Code c√≥ c·∫•u tr√∫c r√µ r√†ng
3. **T√≠nh hi·ªáu su·∫•t:** Caching v√† t·ªëi ∆∞u h√≥a database
4. **T√≠nh b·∫£o m·∫≠t:** Authentication v√† validation
5. **T√≠nh real-time:** SignalR cho tr·∫£i nghi·ªám ng∆∞·ªùi d√πng t·ªët

C√°c design patterns ƒë∆∞·ª£c s·ª≠ d·ª•ng gi√∫p code d·ªÖ hi·ªÉu, d·ªÖ test v√† d·ªÖ maintain, ƒë√°p ·ª©ng c√°c nguy√™n t·∫Øc SOLID v√† clean architecture. 